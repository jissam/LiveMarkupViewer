{
  "version": 3,
  "sources": ["../../src/web-components/comments/components/annotation-pin.ts"],
  "sourcesContent": ["import { CSSResultGroup, LitElement, PropertyValueMap, html } from 'lit';\n\nimport { classMap } from 'lit/directives/class-map.js';\n\nimport { Participant, ParticipantByGroupApi } from '../../../common/types/participant.types';\nimport { StoreType } from '../../../common/types/stores.types';\nimport { Annotation, PinCoordinates } from '../../../components/comments/types';\nimport { WebComponentsBase } from '../../base';\nimport importStyle from '../../base/utils/importStyle';\nimport { annotationPinStyles } from '../css';\n\nimport { PinMode, HorizontalSide, Sides } from './types';\nimport { CreateElement } from '../../global/decorators/create-element.decorator';\n\nconst WebComponentsBaseElement = WebComponentsBase(LitElement);\nconst styles: CSSResultGroup[] = [WebComponentsBaseElement.styles, annotationPinStyles];\n\n@CreateElement('superviz-comments-annotation-pin')\nexport class CommentsAnnotationPin extends WebComponentsBaseElement {\n  declare type: PinMode;\n  declare active: boolean;\n  declare annotation: Annotation;\n  declare position: Partial<PinCoordinates>;\n  declare showInput: boolean;\n  declare containerSides: Sides;\n  declare horizontalSide: HorizontalSide | undefined;\n  declare commentsSide: HorizontalSide;\n  declare movedPosition: string;\n  declare pinAnnotation: HTMLElement;\n  declare localAvatar: string | undefined;\n  declare annotationSent: boolean;\n  declare localName: string;\n  declare keepPositionRatio: boolean;\n  declare participantsList: ParticipantByGroupApi[];\n  declare firstLoad: boolean;\n  declare newPin: boolean;\n\n  private originalPosition: Partial<PinCoordinates>;\n  private annotationSides: Sides;\n  private inputElement: HTMLTextAreaElement;\n\n  static styles = styles;\n  static properties = {\n    type: { type: String },\n    annotation: { type: Object },\n    position: { type: Object },\n    active: { type: Boolean },\n    showInput: { type: Boolean },\n    containerSides: { type: Object },\n    horizontalSide: { type: String },\n    commentsSide: { type: String },\n    movedPosition: { type: String },\n    pinAnnotation: { type: Object },\n    localAvatar: { type: String },\n    annotationSent: { type: Boolean },\n    localName: { type: String },\n    keepPositionRatio: { type: Boolean },\n    participantsList: { type: Object },\n    firstLoad: { type: Boolean },\n    newPin: { type: Boolean },\n  };\n\n  constructor() {\n    super();\n    this.position = { x: 0, y: 0 };\n    setTimeout(() => {\n      this.firstLoad = false;\n    }, 800);\n  }\n\n  protected updated(_changedProperties: PropertyValueMap<any> | Map<PropertyKey, unknown>): void {\n    super.updated(_changedProperties);\n\n    if (!_changedProperties.has('movedPosition') || !this.annotationSides) return;\n    this.annotationSides = this.pinAnnotation.getBoundingClientRect();\n    this.setInputSide();\n\n    if (!this.inputElement) return;\n    this.focusInput();\n  }\n\n  protected firstUpdated(\n    _changedProperties: PropertyValueMap<any> | Map<PropertyKey, unknown>,\n  ): void {\n    super.firstUpdated(_changedProperties);\n    importStyle.call(this, ['comments']);\n\n    if (!this.showInput) return;\n\n    this.originalPosition = { ...this.position };\n    this.pinAnnotation = this.shadowRoot?.querySelector('.comments__annotation-pin');\n    this.annotationSides = this.pinAnnotation.getBoundingClientRect();\n    this.setInputSide();\n  }\n\n  private focusInput = () => {\n    if (!this.inputElement) {\n      this.inputElement = this.shadowRoot\n        ?.querySelector('superviz-comments-comment-input')\n        ?.shadowRoot!.querySelector('textarea') as HTMLTextAreaElement;\n    }\n\n    this.inputElement.focus();\n  };\n\n  private setInputSide = () => {\n    const inputWidth = 286;\n    const gapWidth = 7;\n    const extraWidth = inputWidth + gapWidth;\n\n    let commentsWidth = this.commentsSide === 'right' ? 320 : 0;\n\n    const right = this.annotationSides.right + extraWidth;\n    const rightLimit = this.containerSides.right - commentsWidth;\n    if (right < rightLimit) {\n      this.horizontalSide = 'right';\n      return;\n    }\n\n    commentsWidth = this.commentsSide === 'left' ? 320 : 0;\n    const left = this.annotationSides.left - extraWidth;\n    const leftLimit = this.containerSides.left + commentsWidth;\n    if (left > leftLimit) {\n      this.horizontalSide = 'left';\n      return;\n    }\n\n    this.horizontalSide = leftLimit - left > right - rightLimit ? 'right' : 'left';\n  };\n\n  private createComment = ({ detail }: CustomEvent) => {\n    this.annotationSent = true;\n    document.body.dispatchEvent(\n      new CustomEvent('create-annotation', {\n        detail: { ...detail, position: { ...this.originalPosition, type: 'canvas' } },\n      }),\n    );\n\n    this.annotation = null;\n  };\n\n  private cancelTemporaryAnnotation = () => {\n    this.annotation = null;\n  };\n\n  private cancelTemporaryAnnotationEsc = (event: KeyboardEvent) => {\n    this.annotation = null;\n  };\n\n  connectedCallback(): void {\n    super.connectedCallback();\n\n    if (this.type !== PinMode.ADD) return;\n\n    const { localParticipant } = this.useStore(StoreType.GLOBAL);\n    localParticipant.subscribe((participant) => {\n      this.localAvatar = participant?.avatar?.imageUrl;\n      this.localName = participant?.name;\n    });\n\n    window.document.body.addEventListener(\n      'close-temporary-annotation',\n      this.cancelTemporaryAnnotation,\n    );\n\n    window.document.body.addEventListener('keyup', (e) => {\n      if (e.key === 'Escape') {\n        this.cancelTemporaryAnnotationEsc(e);\n      }\n    });\n  }\n\n  disconnectedCallback(): void {\n    super.disconnectedCallback();\n\n    if (this.type !== PinMode.ADD) return;\n\n    window.document.body.removeEventListener(\n      'close-temporary-annotation',\n      this.cancelTemporaryAnnotation,\n    );\n\n    window.document.body.removeEventListener('keyup', (e) => {\n      if (e.key === 'Escape') {\n        this.cancelTemporaryAnnotationEsc(e);\n      }\n    });\n  }\n\n  get userAvatar() {\n    return this.annotation?.comments?.at(0)?.participant?.avatar || this.localAvatar;\n  }\n\n  get userInitial(): string {\n    const name =\n      (this.annotation?.comments?.at(0)?.participant?.name ?? this.localName) || 'Anonymous';\n\n    return name[0].toUpperCase();\n  }\n\n  private emitClick(): void {\n    document.body.dispatchEvent(\n      new CustomEvent('select-annotation', {\n        detail: { uuid: this.annotation?.uuid },\n      }),\n    );\n  }\n\n  private avatar = () => {\n    if (this.type === PinMode.ADD && !this.showInput) {\n      return html`<div\n        class=\"comments__annotation-pin__avatar comments__annotation-pin__avatar--add\"\n      >\n        <superviz-icon name=\"add\"></superviz-icon>\n      </div>`;\n    }\n\n    const avatar = this.userAvatar;\n    if (avatar) {\n      return html`<div class=\"comments__annotation-pin__avatar\">\n        <img src=${avatar} />\n      </div>`;\n    }\n\n    return html`<div class=\"comments__annotation-pin__avatar\">\n      <p class=\"text text-bold text-big\">${this.userInitial}</p>\n    </div>`;\n  };\n\n  private input = () => {\n    if (!this.showInput || this.annotationSent) return;\n    return html`<div class=\"floating-input\">\n      <superviz-comments-comment-input\n        @create-annotation=${this.createComment}\n        eventType=\"create-annotation\"\n        @comment-input-ready=${this.focusInput}\n        participantsList=${JSON.stringify(this.participantsList)}\n      >\n      </superviz-comments-comment-input>\n    </div>`;\n  };\n\n  protected render() {\n    const classes = {\n      'comments__annotation-pin': true,\n      preload: this.firstLoad === undefined,\n      'comments__annotation-pin--active': this.active,\n      'comments__cursor-pointer': this.type === PinMode.ADD && !this.showInput,\n      'comments__annotation-pin--add': this.type === PinMode.ADD && this.showInput,\n      [this.horizontalSide]: true,\n    };\n\n    const wrapperClasses = {\n      'comments__annotation-pin-wrapper': true,\n      'comments__annotation-pin-wrapper--new': this.newPin,\n    };\n\n    const unit = this.keepPositionRatio ? '%' : 'px';\n    const style = `top: ${this.position.y}${unit}; left: ${this.position.x}${unit};`;\n\n    if (this.type === PinMode.ADD) {\n      return html`\n        <div class=${classMap(classes)} style=${style}>${this.avatar()} ${this.input()}</div>\n      `;\n    }\n\n    return html`<div class=${classMap(wrapperClasses)} style=${style}>\n      <div @click=${this.emitClick} class=${classMap(classes)}>${this.avatar()}</div>\n    </div> `;\n  }\n}\n"],
  "mappings": "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",
  "names": ["init_define_process_env", "WebComponentsBaseElement", "WebComponentsBase", "s", "styles", "annotationPinStyles", "CommentsAnnotationPin", "_a", "_b", "commentsWidth", "right", "rightLimit", "left", "leftLimit", "detail", "__spreadProps", "__spreadValues", "event", "x", "avatar", "_changedProperties", "importStyle", "localParticipant", "participant", "e", "_c", "_d", "_e", "classes", "wrapperClasses", "unit", "style", "__decorateClass", "CreateElement"]
}
